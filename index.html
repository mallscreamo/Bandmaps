<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bandmaps</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet" />

<style>
  /* Reset & base */
  body, html {
    margin: 0; padding: 0; height: 100%; 
    font-family: 'Oswald', sans-serif;
    background-color: #000;
    color: #fff;
    overflow: hidden;
  }

  /* Layout */
  #sidebar {
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 280px;
    background: #111;
    border-right: 2px solid #444;
    padding: 0;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }

  #map {
    position: absolute;
    top: 0; left: 280px; right: 0; bottom: 0;
  }

  /* Logo container */
  #logo {
    height: 140px;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    border-bottom: 2px solid #444;
    perspective: 800px;
  }

  /* Rotating container */
  #rotator {
    transform-style: preserve-3d;
    animation: rotateSlow 20s linear infinite;
  }

  @keyframes rotateSlow {
    from { transform: rotateY(0deg); }
    to { transform: rotateY(360deg); }
  }

  /* Chrome styled text */
  .chrome-text {
    font-size: 50px;
    font-weight: 900;
    line-height: 1;
    text-transform: uppercase;
    letter-spacing: 6px;
    color: #e0e0e0;
    text-shadow:
      -1px -1px 2px #fff,
      1px 1px 3px #666,
      0 0 15px #ccc,
      0 0 30px #999;
    user-select: none;
    transform: translateZ(30px);
  }

  /* Stack text vertically */
  #logo-text {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Filters & search */
  .filters {
    padding: 20px 20px 10px 20px;
    flex-shrink: 0;
  }

  input[type="text"], select {
    width: 100%;
    padding: 10px;
    margin-bottom: 14px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #444;
    background-color: #222;
    color: #fff;
    font-family: 'Oswald', sans-serif;
  }

  input[type="text"]:focus, select:focus {
    outline: none;
    border-color: #1db954;
    background-color: #2c2c2c;
  }

  /* Band list */
  #bandList {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 20px 20px;
  }

  #bandList h2 {
    font-weight: 700;
    font-size: 16px;
    margin: 10px 0;
    letter-spacing: 1px;
    border-bottom: 1px solid #444;
    padding-bottom: 6px;
  }

  #bandList ul {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 100%;
  }

  #bandList li {
    cursor: pointer;
    padding: 6px 0;
    border-bottom: 1px solid #222;
    font-size: 14px;
    transition: background 0.15s;
  }

  #bandList li:hover {
    background: #1db954;
    color: #000;
  }
</style>
</head>
<body>

<div id="sidebar">
  <div id="logo">
    <div id="rotator">
      <div id="logo-text">
        <div class="chrome-text">BAND</div>
        <div class="chrome-text">MAPS</div>
      </div>
    </div>
  </div>

  <div class="filters">
    <input type="text" id="searchInput" placeholder="Search bands..." />
    <select id="genreFilter">
      <option value="">All Genres</option>
    </select>
    <select id="cityFilter">
      <option value="">All Cities</option>
    </select>
  </div>

  <div id="bandList">
    <h2>All Bands</h2>
    <ul id="bandsUl"></ul>
  </div>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  const SHEET_JSON_URL = 'https://api.sheetbest.com/sheets/3747de06-5460-4172-b3db-5d60c6021cd4';

  const map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const genreFilter = document.getElementById('genreFilter');
  const cityFilter = document.getElementById('cityFilter');
  const searchInput = document.getElementById('searchInput');
  const bandsUl = document.getElementById('bandsUl');

  let allBands = [];
  let markers = [];

  fetch(SHEET_JSON_URL)
    .then(res => res.json())
    .then(data => {
      allBands = data.filter(b => b.Latitude && b.Longitude && b.Name);
      populateFilters(allBands);
      renderMarkers(allBands);
      renderBandList(allBands);
    })
    .catch(err => console.error('Error fetching data:', err));

  function populateFilters(data) {
    const genres = new Set();
    const cities = new Set();

    data.forEach(b => {
      if (b.Genre) genres.add(b.Genre.trim());
      if (b.City) cities.add(b.City.trim());
    });

    genres.forEach(g => {
      const option = document.createElement('option');
      option.value = g;
      option.textContent = g;
      genreFilter.appendChild(option);
    });

    cities.forEach(c => {
      const option = document.createElement('option');
      option.value = c;
      option.textContent = c;
      cityFilter.appendChild(option);
    });

    genreFilter.addEventListener('change', applyFilters);
    cityFilter.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);
  }

  function applyFilters() {
    const selectedGenre = genreFilter.value;
    const selectedCity = cityFilter.value;
    const searchQuery = searchInput.value.toLowerCase();

    const filtered = allBands.filter(b => {
      const matchGenre = !selectedGenre || (b.Genre && b.Genre.trim() === selectedGenre);
      const matchCity = !selectedCity || (b.City && b.City.trim() === selectedCity);
      const matchName = !searchQuery || (b.Name && b.Name.toLowerCase().includes(searchQuery));
      return matchGenre && matchCity && matchName;
    });

    renderMarkers(filtered);
    renderBandList(filtered);
  }

  function renderMarkers(bands) {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    bands.forEach(band => {
      const lat = parseFloat(band.Latitude);
      const lon = parseFloat(band.Longitude);
      if (isNaN(lat) || isNaN(lon)) return;

      const marker = L.marker([lat, lon]).addTo(map);
      marker.bindPopup(`
        <strong>${band.Name}</strong><br>
        <em>${band.Genre || 'Unknown'}</em><br>
        <a href="band.html?name=${encodeURIComponent(band.Name)}" target="_blank" rel="noopener noreferrer">View Details</a>
      `);
      markers.push(marker);
    });
  }

  function renderBandList(bands) {
    bandsUl.innerHTML = '';
    // Sort alphabetically by Name
    bands.sort((a,b) => a.Name.localeCompare(b.Name));

    bands.forEach(band => {
      const li = document.createElement('li');
      li.textContent = band.Name;
      li.title = `${band.Genre || ''} â€” ${band.City || ''}`;
      li.onclick = () => {
        const lat = parseFloat(band.Latitude);
        const lon = parseFloat(band.Longitude);
        if (!isNaN(lat) && !isNaN(lon)) {
          map.setView([lat, lon], 8, { animate: true });
          // Open popup on marker
          const marker = markers.find(m => {
            const latlng = m.getLatLng();
            return latlng.lat === lat && latlng.lng === lon;
          });
          if (marker) marker.openPopup();
        }
      };
      bandsUl.appendChild(li);
    });
  }
</script>

</body>
</html>
